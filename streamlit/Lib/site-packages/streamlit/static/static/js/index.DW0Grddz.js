import{r as a,E as J,_ as W,u as G,aH as F,aI as $,m as R,aJ as X,aK as K,aL as L,aM as I,aN as Q,aO as Y,o as M,aP as H,x as P,aQ as Z,aR as q,aS as ee,J as te,a4 as ne,at as se,aT as re,j as A,e as ae,aU as oe,aV as ce,aW as ie}from"./index.6xX1278W.js";import{w as le,E as ue}from"./withFullScreenWrapper.C3561XxJ.js";import{a as j,S as k,T as fe}from"./Toolbar.C77ar7rq.js";import{R as de}from"./index.CFMf5_ez.js";import{u as me}from"./FormClearHelper.DTcdrasw.js";import"./sprintf.D7DtBTRn.js";import"./checkbox.yZOfXCeX.js";import"./createDownloadLinkElement.ZaXNnPK4.js";import"./toConsumableArray.De7I7KVR.js";import"./possibleConstructorReturn.CqidKeei.js";import"./createSuper.Dh9w1cs8.js";import"./FileDownload.esm.CN4j9-1w.js";var U=a.forwardRef(function(n,t){var r={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return a.createElement(J,W({iconAttrs:r,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),a.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),a.createElement("path",{d:"M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V5h14v14zM7 10h2v7H7zm4-3h2v10h-2zm4 6h2v4h-2z"}))});U.displayName="InsertChart";var B=a.forwardRef(function(n,t){var r={fill:"currentColor",xmlns:"http://www.w3.org/2000/svg"};return a.createElement(J,W({iconAttrs:r,iconVerticalAlign:"middle",iconViewBox:"0 0 24 24"},n,{ref:t}),a.createElement("path",{fill:"none",d:"M0 0h24v24H0V0z"}),a.createElement("path",{d:"M20 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h15c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 2v3H5V5h15zm-5 14h-5v-9h5v9zM5 10h3v9H5v-9zm12 9v-9h3v9h-3z"}))});B.displayName="TableChart";const he=20;function pe(n){"params"in n&&"encoding"in n&&n.params.forEach(t=>{"select"in t&&(["interval","point"].includes(t.select)&&(t.select={type:t.select}),"type"in t.select&&t.select.type==="point"&&!("encodings"in t.select)&&R(t.select.encodings)&&(t.select.encodings=Object.keys(n.encoding)))})}const ge=(n,t,r,s,u,i,l,p)=>{const e=JSON.parse(n);if(s==="streamlit"?e.config=F(e.config,i):e.usermeta?.embedOptions?.theme==="streamlit"?(e.config=F(e.config,i),e.usermeta.embedOptions.theme=void 0):e.config=$(e.config,i),e.title&&(typeof e.title=="string"&&(e.title={text:e.title}),e.title.limit=e.title.limit??Math.max(l-40,0)),r&&(e.height=p),t&&(e.width=l,"vconcat"in e&&e.vconcat.forEach(d=>{d.width=l})),e.padding||(e.padding={}),R(e.padding.bottom)&&(e.padding.bottom=he),e.datasets)throw new Error("Datasets should not be passed as part of the spec");return u.length>0&&pe(e),e},Se=(n,t,r,s,u)=>{const i=G(),{id:l,formId:p,spec:e,data:d,datasets:o,vegaLiteTheme:f,selectionMode:c}=n,g=a.useMemo(()=>c,[JSON.stringify(c)]),w=a.useMemo(()=>ge(e,s,u,f,g,i,t,r),[e,s,u,f,g,i,t,r]);return{id:l,formId:p,vegaLiteTheme:f,spec:w,selectionMode:g,data:d,datasets:o,useContainerWidth:s}},ye={DATAFRAME_INDEX:"(index)"};function we(n){return!n||n.dimensions.numDataRows===0?null:D(n)}function be(n){const t=x(n);if(R(t))return null;const r={};for(const[s,u]of Object.entries(t))r[s]=D(u);return r}function x(n){if(n?.length===0)return null;const t={};return n.forEach(r=>{if(!r)return;const s=r.hasName?r.name:null;t[s]=r.data}),t}function D(n,t=0){if(n.dimensions.numDataRows===0)return[];const r=[],{numDataRows:s,numDataColumns:u,numIndexColumns:i}=n.dimensions,l=n.columnTypes[0]??void 0,p=l&&l.type===X.INDEX&&(K(l)||L(l)||I(l));for(let e=t;e<s;e++){const d={};if(p){const{content:o}=n.getCell(e,0);d[ye.DATAFRAME_INDEX]=typeof o=="bigint"?Number(o):o}for(let o=0;o<u;o++){const f=o+i,{content:c,contentType:g}=n.getCell(e,f);if((c instanceof Date||typeof c=="number"&&Number.isFinite(c))&&(L(g)||I(g))&&!Q(g)){const w=new Date(c).getTimezoneOffset()*60*1e3;d[n.columnNames[0][f]]=c.valueOf()+w}else d[n.columnNames[0][f]]=typeof c=="bigint"?Number(c):c}r.push(d)}return r}const Ce=150,Ee=P.getLogger("useVegaLiteSelections"),Ve=(n,t,r)=>{const{id:s,formId:u,selectionMode:i}=n,l=a.useCallback(e=>{i.forEach(o=>{e.addSignalListener(o,Y(Ce,(f,c)=>{const g=e.getState({data:(S,y)=>i.some(E=>`${E}_store`===S),recurse:!1});M(g)&&t.setElementState(s,"viewState",g);let w=c;"vlPoint"in c&&"or"in c.vlPoint&&(w=c.vlPoint.or);const O={id:s,formId:u},h=JSON.parse(t.getStringValue(O)||"{}"),m={selection:{...h?.selection||{},[f]:w||{}}};H(h,m)||t.setStringValue(O,JSON.stringify(m),{fromUi:!0},r)}))});const d=t.getElementState(s,"viewState");if(M(d))try{return e.setState(d)}catch(o){Ee.warn("Failed to restore view state",o)}return e},[s,i,t,u,r]),p=a.useCallback(()=>{const e={selection:{}};i.forEach(c=>{e.selection[c]={}});const d={id:s,formId:u},o=t.getStringValue(d),f=o?JSON.parse(o):e;H(f,e)||t.setStringValue(d,JSON.stringify(e),{fromUi:!0},r)},[s,u,r,i,t]);return{maybeConfigureSelections:l,onFormCleared:p}},_="source",ve=P.getLogger("useVegaEmbed");function Ne(n,t,r){const s=a.useRef(null),u=a.useRef(null),i=a.useRef(_),l=a.useRef(null),p=a.useRef([]),{maybeConfigureSelections:e,onFormCleared:d}=Ve(n,t,r);me({widgetMgr:t,element:n,onFormCleared:d});const{data:o,datasets:f}=n;a.useEffect(()=>{s.current===null&&(l.current=o,p.current=f)},[o,f]);const c=a.useCallback(()=>{u.current&&u.current(),u.current=null,s.current=null},[]),g=a.useCallback(async(h,m)=>{if(h.current===null)throw new Error("Element missing.");c();const S={ast:!0,expr:q,tooltip:{disableDefaultStyle:!0},defaultStyle:!1,forceActionsMenu:!0},{vgSpec:y,view:E,finalize:N}=await Z(h.current,m,S);s.current=e(E),u.current=N;const b=be(p.current),V=b?Object.keys(b):[];if(V.length===1){const[C]=V;i.current=C}else V.length===0&&y.data&&(i.current=_);const v=we(l.current);if(v&&s.current.insert(i.current,v),b)for(const[C,T]of Object.entries(b))s.current.insert(C,T);return await s.current.runAsync(),await s.current.resize().runAsync(),s.current},[c,e]),w=a.useCallback((h,m,S,y)=>{if(!y||y.dimensions.numDataRows===0){try{h.remove(m,ee)}finally{}return}if(!S||S.dimensions.numDataRows===0){h.insert(m,D(y));return}y.hash!==S.hash&&(h.data(m,D(y)),ve.info(`Had to clear the ${m} dataset before inserting data through Vega view.`))},[]),O=a.useCallback(async(h,m)=>{if(s.current===null)return null;const S=l.current,y=p.current;(S||h)&&w(s.current,i.current,S,h);const E=x(y)??{},N=x(m)??{};for(const[b,V]of Object.entries(N)){const v=b||i.current,C=E[v];w(s.current,v,C,V)}for(const b of Object.keys(E))!Object.hasOwn(N,b)&&b!==i.current&&w(s.current,b,null,null);return await s.current?.resize().runAsync(),l.current=h,p.current=m,s.current},[w]);return{createView:g,updateView:O,finalizeView:c}}function Te(n){try{const t=typeof n=="string"?JSON.parse(n):n;return!!(t.facet||t.encoding?.row||t.encoding?.column||t.encoding?.facet)}catch{return!1}}const Oe=({disableFullscreenMode:n,element:t,fragmentId:r,widgetMgr:s,widthConfig:u,heightConfig:i})=>{const[l,p]=a.useState(!1),[e,d]=a.useState(!1),{expanded:o,height:f,width:c,expand:g,collapse:w}=te(ue),{width:O,height:h,elementRef:m}=ne([l],0),S=se(u)||t.useContainerWidth,y=re(i),E=Te(t.spec),N=Se(t,E?c??0:O,(o?f:h)??0,o?!0:S,o?!0:y),{createView:b,updateView:V,finalizeView:v}=Ne(N,s,r),{data:C,datasets:T,spec:z}=N;return a.useLayoutEffect(()=>(m.current!==null&&b(m,z),v),[b,v,z,c,f,l,m]),a.useEffect(()=>{V(C,T)},[C,T,V]),a.useEffect(()=>{C||T?.[0]?.data?d(!0):d(!1)},[C,T]),l?A(de,{data:C??T[0]?.data,height:f??h??void 0,customToolbarActions:[A(j,{label:"Show chart",icon:U,onClick:()=>{p(!1)}},"show-chart")]}):ae(k,{height:y?o?f:"100%":f,useContainerWidth:o?!0:S,children:[A(fe,{target:k,isFullScreen:o,onExpand:g,onCollapse:w,disableFullscreenMode:n,children:e&&A(j,{label:"Show data",icon:B,onClick:()=>{p(!0)}})}),A(ce,{styles:[oe]}),A(ie,{"data-testid":"stVegaLiteChart",className:"stVegaLiteChart",useContainerWidth:S,useContainerHeight:y,ref:m})]})},Ae=le(Oe),Je=a.memo(Ae);export{oe as StyledVegaLiteChartTooltips,F as applyStreamlitTheme,Je as default};
